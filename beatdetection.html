<!DOCTYPE html>
<html>
<head>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width">
  <script type="text/javascript" src="js/webcomponents-lite.js"></script>

  <link rel="import" href="circuit_ui/circuit_component/circuit_component.html" >
  <script type="text/javascript" src="js/jackdaw.beatdetection.js"></script>
  <script type="text/javascript" src="js/jackdaw.waveformdisplay.js"></script>
  <script type="text/javascript" src="js/jackdaw.audioexport.js"></script>
  <script type="text/javascript" src="js/jackdaw.nativerecorder.js"></script>

  <!-- // <script type="text/javascript" src="js/jackdaw.midicircuit.js"></script> -->

 
  <title>Jackdaw Beatdetection</title>
  <style type="text/css">
    
    svg {
       fill:orange;
       position: absolute;
       left: 9px;
    }
    .downloadlink{
      clear:both;
      display: block;
    }
    .recording{
      background-color: red;
      color: white;
    }
    #canvascontainer{
      /*overflow-x:auto;*/
      position: relative;
      width:100%;
      height:200px;
      border:solid 1px #999;
    }
    #svg,#waveform{
        position: absolute;
        top:0;
        left:0;
    }
  </style>
</head>

<body>
  

  
<div id="text"></div>

<div id="canvascontainer">
  <svg id="svg"></svg>
  <canvas id="waveform"></canvas>
</div>

<button id="rec" onClick="Startrecording(this)">Record</button>
<!-- <button id="play" onClick="Stoprecording()">Play</button> -->

<div id="slicebuts"></div>
<br>
<!-- <input id="startpointslider" onInput="Jackdaw.Beatdetection.updatepeaks(this.value)" min="1" max="100" step="1" value="0" type="range"/> -->
<!-- <input id="endpointslider" onInput="Jackdaw.Beatdetection.updateends(this.value)" min="1" max="100" step="1" value="0" type="range"/> -->
<!-- <button onClick="Jackdaw.Beatdetection.reverseslice()">Reverse slice</button>
<button onClick="Jackdaw.Beatdetection.boostbass()">Boost bass</button>

<button onClick="Jackdaw.Beatdetection.getcurrentslicebuffer()">Export slice</button>
<button onClick="Jackdaw.Beatdetection.getallslices()">Export all slices</button>
<br><br>
 -->
 <circuit-component name="nigel"></circuit-component>

<script>

    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var context = new AudioContext();


    document.addEventListener("DOMContentLoaded",function(){

             Jackdaw.Beatdetection.init();
             Jackdaw.Nativerecorder.init();
             // Jackdaw.Midicircuit.init();


             var recbut;

              // images = ["sounds/snaredry.wav","sounds/snare.wav","sounds/kick.wav","sounds/hihat.wav"];
               file = "sounds/somegit.wav";

               var xhr = new XMLHttpRequest();
                xhr.open('GET', file, true);
                xhr.responseType = 'arraybuffer';

                xhr.onload = function(e) {
                  if (this.status == 200) {


                          // make  copy of buffer
                          var buf2 = this.response.slice(0);
                          Jackdaw.Beatdetection.calculatetempo(buf2); 

                          context.decodeAudioData(this.response, function(buffer) {
                            Jackdaw.Waveformdisplay.drawbuffer(buffer)
                          }, 
                            function(e){console.log("error ",e)}
                          );
                  }
                };
                xhr.send();

              });

             

              function Startrecording(but){
                  recbut = but;
                  if(recbut.className!="recording"){
                    recbut.className = "recording";
                    Jackdaw.Nativerecorder.startrecorder();
                  }else{
                    recbut.className = "";
                    Jackdaw.Nativerecorder.stoprecorder();
                  }
              }
   

              document.body.addEventListener('nativerecorderevent', function (ev) { 

                  console.log("nativerecorderevent",ev.detail) 
                  
                  let fileReader = new FileReader();
                  let arrayBuffer;

                  fileReader.onloadend = () => {
                      arrayBuffer = fileReader.result;

                      context.decodeAudioData(arrayBuffer, function(buffers) {
                        Jackdaw.Waveformdisplay.drawbuffer(buffers)
                        Jackdaw.Beatdetection.calc( buffers ); 
                      });
                  }

                  fileReader.readAsArrayBuffer(ev.detail);                

              }, false);
           

              var circuitcomponent = document.getElementsByTagName("circuit-component")[0];

              document.body.addEventListener('circuituievent', function (ev) { 

                    console.log("circuituievent",ev.detail) 

                    if(ev.detail.data1==176){

                      if(ev.detail.data2==49){
                        Jackdaw.Beatdetection.updatepeaks(parseInt(ev.detail.data3))
                      }
                      if(ev.detail.data2==50){
                        Jackdaw.Beatdetection.updateends(parseInt(ev.detail.data3))
                      }

                    }
                    if(ev.detail.data1==144){
                        //Button Down
                        // console.log("testtttt",circuitcomponent._getbuttonnumber(parseInt(ev.detail.data2)) )

                        var databut = circuitcomponent._getbuttonnumber(parseInt(ev.detail.data2))
                        
                        if(databut!=undefined){
                          if(Number.isInteger(databut)){
                            Jackdaw.Beatdetection.playslice(circuitcomponent._getbuttonnumber(parseInt(ev.detail.data2)))
                          }else{
                            console.log("Run fuction...",databut);                       
                            //If there is a function stored on the button run it.....
                            var methods = databut.split(".");
                            var result = window;
                            for(var i in methods) {
                                result = result[methods[i]];
                            }
                            //execute it
                            result();
                          }
                        }


                    }
                    if(ev.detail.data1==128){
                        //BUTTON RELEASED
                    }

              }, false);

            
               
              //test
              // document.getElementsByTagName("circuit-component")[0]._setbutton([108,'red','Boaty'])   
       


</script>
</body>