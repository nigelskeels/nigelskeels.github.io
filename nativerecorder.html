<!DOCTYPE html>
<!-- <html manifest="jackdawsampler.appcache"> -->
<html>
<head>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width">
  <title>Jackdaw native recorder</title>
</head>

<body>
  

  <button id="record">record</button>
  <button id="stop">stop</button>
  <button id="play">play</button>
  <div id="soundClips"></div>

    <script>
  
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    navigator.getUserMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);

    var context = new AudioContext();
    
    var record = document.querySelector('#record');
    var stop = document.querySelector('#stop');
    var soundClips = document.querySelector('#soundClips');

   
    
    if (navigator.getUserMedia) {
        console.log('getUserMedia supported.');

        var constraints = { audio: true };
        var chunks = [];

        var onSuccess = function(stream) {
            var mediaRecorder = new MediaRecorder(stream);

            record.onclick = function() {
              mediaRecorder.start();
              console.log(mediaRecorder.state);
              console.log("recorder started");
              record.style.background = "red";

              stop.disabled = false;
              record.disabled = true;
            }

            stop.onclick = function() {
              mediaRecorder.stop();
              console.log(mediaRecorder.state);
              console.log("recorder stopped");
              record.style.background = "";
              record.style.color = "";
              // mediaRecorder.requestData();

              stop.disabled = true;
              record.disabled = false;
            }

            mediaRecorder.onstop = function(e) {
              console.log("onstop() called.",e);
              
               // var clipContainer = document.createElement('article');
               // var audio = document.createElement('audio');
               // clipContainer.classList.add('clip');
               // audio.setAttribute('controls', '');
               // clipContainer.appendChild(audio);
               // soundClips.appendChild(clipContainer);
               // audio.controls = true;
                //var blob = new Blob([].concat(chunks), { 'type' : 'audio/wav' });
               var blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });

               // var audioURL = window.URL.createObjectURL(blob);
               

               


               // console.log("test",audioURL);

                // var xhr = new XMLHttpRequest();
                // xhr.open('GET', audioURL, true);
                // xhr.responseType = 'arraybuffer';

                // xhr.onload = function(e) {
                //   if (this.status == 200) {
                        
                //           context.decodeAudioData(this.response, function(buffer) {
                //              playsound(buffer); 
                //           }, 
                //             function(e){console.log("error ",e)}
                //           );
                //   }
                // };
                // xhr.send();

                 // var reader = new FileReader();
                 //  reader.onload = function(){
                 //      var generatedBuffer = reader.result;
                 //      console.log("generatedBuffer",generatedBuffer);
                 //  }
                 //  reader.readAsDataURL(blob);

               // var araybuf = new ArrayBuffer(chunks.length)


                // var uint8Array = new Uint8Array(chunks);
                var reader = new FileReader();
                reader.onload = function() {
                   var dataURI = reader.result;
                    
                  

                    var byteString = atob(dataURI.split(',')[1]);

                    // separate out the mime component
                    // var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

                    // write the bytes of the string to an ArrayBuffer
                    var ab = new ArrayBuffer(byteString.length);
                    var ia = new Uint8Array(ab);
                    for (var i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }

                    console.log("uint array",ia,ia.length);

                    // write the ArrayBuffer to a blob, and you're done
                    // var bb = new BlobBuilder();
                    // bb.append(ab);
                    // return bb.getBlob(mimeString);

                  


                     var otherbuffer = context.createBuffer(2, ia.length, context.sampleRate);
                     var channel0 = otherbuffer.getChannelData(0);
                     channel0.set( ia, 0);
                     var channel1 = otherbuffer.getChannelData(1);
                     channel1.set( ia, 0);
                      playsound(otherbuffer); 


                    // context.decodeAudioData(ab, function(buffer) {
                    //   playsound(buffer); 
                    // }, 
                    // function(e){console.log("error ",e)}
                    // );

                  // deferred.resolve();
                };
                // reader.readAsArrayBuffer(blob);
                reader.readAsDataURL(blob);




              //  chunks = [];
                // audio.src = audioURL;
              // var reader = new FileReader();
              // reader.onload = function(buf){
                
              //   console.log("reader",buf.target.result);
                // context.decodeAudioData(chunks, function(buffer) {
                //   playsound(buffer); 
                // }, 
                //   function(e){console.log("error ",e)}
                // );
              // }
              // //reader.readAsDataURL(blob);
              // reader.readAsArrayBuffer(araybuf);

            }

            mediaRecorder.ondataavailable = function(e) {
              chunks.push(e.data);
            }
          }

          var onError = function(err) {
            console.log('The following error occured: ' + err);
          }

          navigator.getUserMedia(constraints, onSuccess, onError);


    } else {
       console.log('getUserMedia not supported on your browser!');
    }

    




    function playsound(thisbuffer){
          var source = context.createBufferSource();
          source.buffer = thisbuffer;                    
          source.connect(context.destination);       
          source.start(0);                   
    }




</script>
</body>