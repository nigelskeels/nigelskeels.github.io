<script src='hypermodernism.midi.js'></script>
<link rel="import" href="../knob_component/knob_component.html" >

<script type="text/javascript">
(function() {
'use strict';
 
// Feature detect
// if (!(window.customElements && document.body.attachShadow)) {
//   document.querySelector('circuit-component').innerHTML = "<b>Your browser doesn't support Shadow DOM and Custom Elements v1.</b>";
//   return;
// }

 
customElements.define('circuit-component', class extends HTMLElement {

  constructor() {
    super(); // always call super() first in the ctor.


    // Create shadow DOM for the component.
    let shadowRoot = this.attachShadow({mode: 'open'});
  
  
    //The following array is like this ... [midinumber,color,buttontitle]

    this.buttonmap=[
                      [null],
                      [56,null],[57,null],[58,null],[59,null],[60,null],[61,null],[62,null],[63,null],   [82,null],
                      [48,null],[49,null],[50,null],[51,null],[52,null],[53,null],[54,null],[55,null],   [83,null],
                      [40,null],[41,null],[42,null],[43,null],[44,null],[45,null],[46,null],[47,null],   [84,null],
                      [32,null],[33,null],[34,null],[35,null],[36,null],[37,null],[38,null],[39,null],   [85,null],
                      [24,null],[25,null],[26,null],[27,null],[28,null],[29,null],[30,null],[31,null],   [86,null],
                      [16,null],[17,null],[18,null],[19,null],[20,null],[21,null],[22,null],[23,null],   [87,null],
                      [8,null] ,[9,null] ,[10,null],[11,null],[12,null],[13,null],[14,null],[15,null],   [88,null],
                      [0,null] ,[1,null] ,[2,null] ,[3,null] ,[4,null] ,[5,null] ,[6,null] ,[7,null] ,   [89,null],

                      [64,null],[65,null],[66,null],[67,null],[68,null],[69,null],[70,null],[71,null],   [98,null]
    ]

    
    this.slidermap = {80:1,81:2,82:3,83:4,84:5,85:6,86:7,87:8,74:9}
    this.timeout={}
    this.timeoutval = 500;
    this.midienabled = true;


    this.defaultbuttonmap = this.buttonmap.slice(0);

    this.buttonSlot;
  
    shadowRoot.innerHTML = `
  
      <style>
        :host {
          display: block;
          width: 768px;
          height:580px;
          overflow:hidden;
          font-family: 'helvetica';
          contain: content;
          background-color: #656565;
          padding:10px;
          border-radius:10px;
          // background-image:url("");
          // background-repeat: no-repeat;
          // background-position: 746px 562px;I think he's popped off somewhere          // background-size: 33px 27px;
        }
        .but{
          height:60px;
          width:60px;
          float:left;
          border-radius:5px;
          margin:4px;
          position:relative;
          font-family: 'helvetica';
          // font-weight:bold;
          font-size: 14px;
          box-sizing: border-box;
          overflow:hidden;
          // white-space: nowrap;
          // text-overflow: ellipsis;
        }
        .round{
          position:relative;
          height:50px;
          width:50px;
          border-radius:50%;
          margin:9px;
          overflow:visible;
        }

        .firstlast{
          margin-right:25px;
          margin-left:25px;
        }
        .round{
          margin-right:30px;
          margin-left:30px;
        }

        .round label{
          display:block;
          position:absolute;
          top:9px;
          left:40px;
          // white-space: nowrap;
          width:70px;
          text-align:left;
          color:#fff;
        }

        .thin{
           height:30px;
        }
        
        .bot{
          margin:15px 18px 14px 25px;
        }

        .bot label{
          display:block;
          position:absolute;
          top:40px;
          left:-13px;
          text-align:center;
          white-space: normal;
          color:#fff;
        }

        .square{
          border-radius:5px;
          margin: 15px 0 0 16px;
        }
        
        .red{
          background-color:red;
          color:#fff;
        }
        .green{
          background-color:green;
          color:#fff;
        }
        .yellow{
          background-color:yellow;
          // color:#fff;
        }

        .greenflash{
          background-color: green;
          color: #fff;
          animation: backgroundblinker .5s step-end infinite alternate;
          -webkit-animation: backgroundblinker .5s step-end infinite alternate;
        }

        .redflash{
          background-color: red;
          color: black;
          animation: backgroundblinker .5s step-end infinite alternate;
          -webkit-animation: backgroundblinker .5s step-end infinite alternate;
        }

        .yellowflash{
          background-color: yellow;
          color: black;
          animation: backgroundblinker .5s step-end infinite alternate;
          -webkit-animation: backgroundblinker .5s step-end infinite alternate;
        }


        @-webkit-keyframes backgroundblinker { 
           // 50% { background-color: transparent; } 
           50% { background-color: #DDD; color:black;} 

        }
        @keyframes backgroundblinker { 
           // 50% { background-color: transparent; } 
           50% { background-color: #DDD; color:black;} 

        }
        
        #sliders{
          // border:solid red 1px;
          // width:665px;
          margin:30px 0 30px 30px;
          position:relative;
        }

        knob-component{
          display:inline-block;
          margin-right:11px;
          padding: 0 0 41px 0 ;
        }

         knob-component:nth-child(odd){
          padding:0;
         }

         knob-component:nth-child(1){
          margin-right:30px;
         }

         knob-component:nth-child(10){
          position:absolute;
          top:0;
          right:16px;
          height:70px;
          width:70px;
        }

        input[type=range].vertical
        {
            display:inline-block;
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 72px;
            height: 50px;
            margin-top:0px;
            margin-bottom: 10px;
            padding-top:0px;
            padding-bottom: 10px;
        }

        input[type=range].vertical.low{
            display:inline-block;
            margin-top:10px;
            margin-bottom: 0px;
            padding-top:10px;
            padding-bottom: 0px;
        }
        
        

      </style>
      <div id="sliders">
        <knob-component id="slider1" mid="48" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider2" mid="49" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider3" mid="50" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider4" mid="51" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider5" mid="52" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider6" mid="53" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider7" mid="54" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider8" mid="55" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider9" mid="56" value="64" min="0" max="128" offsetangle="180"></knob-component>
        <knob-component id="slider10" mid="57" value="64" min="0" max="128" offsetangle="180"></knob-component>

      </div>
      <div id="buttonSlot"></div>
    `;
  }
  
        // <label for="slider1"></label><input id="slider1" mid="48" type="range" min="0" max="128" value="0" class="vertical low">
        // <label for="slider2"></label><input id="slider2" mid="49" type="range" min="0" max="128" value="0" class="vertical">
        // <label for="slider3"></label><input id="slider3" mid="50" type="range" min="0" max="128" value="0" class="vertical low">
        // <label for="slider4"></label><input id="slider4" mid="51" type="range" min="0" max="128" value="0" class="vertical">
        // <label for="slider5"></label><input id="slider5" mid="52" type="range" min="0" max="128" value="0" class="vertical low">
        // <label for="slider6"></label><input id="slider6" mid="53" type="range" min="0" max="128" value="0" class="vertical">
        // <label for="slider7"></label><input id="slider7" mid="54" type="range" min="0" max="128" value="0" class="vertical low">
        // <label for="slider8"></label><input id="slider8" mid="55" type="range" min="0" max="128" value="0" class="vertical">
        // <label for="slider9"></label><input id="slider8" mid="56" type="range" min="0" max="128" value="0" class="vertical low">
  
  set data(data){
    this.buttonmap=data
    this._updateshaddowdom()
  }

  get data(){
    return this.buttonmap;
  }

  
  setbutton(data){
    var index = this.buttonmap.findIndex(x => x[0]==data[0]);
    this.buttonmap[index]=data
    this._updateshaddowdom()
  }


  connectedCallback() {  
    
      if(this.midienabled==true){
        Hypermodernism.Midi.init()
      }

      this.buttonSlot = this.shadowRoot.querySelector('#buttonSlot');
      this.sliders = this.shadowRoot.querySelector('#sliders').getElementsByTagName("knob-component")
      this.test = this.getAttribute('name');


      this.buttonSlot.addEventListener("mousedown", this._onclickbuttondown.bind(this), true);
      this.buttonSlot.addEventListener("mouseup", this._onclickbuttonup.bind(this), true);

      // for (var i = 0; i < this.sliders.length; i++) {
        // this.sliders[i].addEventListener("input", function(e){
        //   _this._broadcastevent(176,e.path[0].getAttribute("mid"),e.path[0].value)
        // });

         
        
      // };

     
      var _this=this;


          document.body.addEventListener('webmidievent', function (e) {
              if(_this.midienabled==true){

                 // console.info('webmidievent recieved',e.detail)
                  _this._broadcastevent(e.detail.data1,e.detail.data2,e.detail.data3)

                  switch (e.detail.data1 & 0xf0) {
                    case 144:
                        //Note On 
                        if (e.detail.data2!=0) {  // if velocity != 0, this is a note-on message
                          console.log("midi call back button= ",midiassignmentmap.pads[e.detail.data2])
                           return;
                        }
                    case 128:
                          //Note off
                          console.log("note off = ",e.detail.data2)
                          return;

                    case 176:
                          //cc value
                          // console.log("midi knob= ",e.detail.data2)
                          
                          _this.sliders[_this.slidermap[e.detail.data2]].value=e.detail.data3;
                          return;
                  }

              }
          }, false);


      setTimeout(function(){
        _this._updateshaddowdom()
      },100);  


      document.addEventListener('knobuievent', function (ev) { 

          console.log("knobuievent",ev.detail) 

      }, false);
     
  }


  _updateshaddowdom(){

     

      this.buttonSlot.innerHTML=""

          
      for (var i = 1; i < 61; i++) {      
              var contactbut = document.createElement('button');
              var label = document.createElement('label');

              if(i<11){
                  contactbut.className = "but thin"     
                     
                  if(i==1 || i==10){
                    contactbut.className = "but thin firstlast" 
                  }
              }
              else{
                if(i % 10===1){
                    contactbut.className = "but round"   
                    
                }
                else if(i % 10===0){
                    contactbut.className = "but round"   
                    
                }
                else{
                    contactbut.className = "but"
                }
              }

              if(this.buttonmap[i][2]!=undefined){
                contactbut.className = contactbut.className+" "+ this.buttonmap[i][1]
              }
           
              contactbut.id = "but"+i;
              if(this.buttonmap[i][2]!=undefined){
                label.innerHTML = this.buttonmap[i][2]
              }
              else{
                //show numbers
                // label.innerHTML = this.buttonmap[i][0]
              }
              
              label.setAttribute('uid', this.buttonmap[i][0]);

              contactbut.setAttribute('uid', this.buttonmap[i][0]);
              this.buttonSlot.appendChild(contactbut)
              contactbut.appendChild(label)


              //set midilights here
              if(this.buttonmap[i][1]!=undefined){

                var colorcode;
                switch(this.buttonmap[i][1]) {
                    case "red":
                        colorcode="03";  
                        break;
                    case "green":
                        colorcode="01";  
                        break;
                    case "yellow":
                        colorcode="05"; 
                        break;
                    case "redflash":
                        colorcode="04"; 
                        break;
                    case "greenflash":
                        colorcode="02"; 
                        break;
                    case "yellowflash":
                        colorcode="06"; 
                        break;
                    default:
                        //off
                        colorcode="00";
                }

                //overide for round red buts
                if(i>72){
                      if(this.buttonmap[i][1]=="redflash"){
                          colorcode="02";
                      }          
                }
                
                if(this.midienabled==true){
                  Hypermodernism.Midi.sendlight("144",this.buttonmap[i][0],colorcode)
                }
              }else{
                if(this.midienabled==true){
                  if(i==1){
                    console.log("1")
                    Hypermodernism.Midi.sendlight("144","56","00")

                  }
                  Hypermodernism.Midi.sendlight("144",this.buttonmap[i][0],"00")
                }
              }

      }

      // this.buttonSlot.addEventListener("mousedown", this._onclickbuttondown.bind(this), true);
      // this.buttonSlot.addEventListener("mouseup", this._onclickbuttonup.bind(this), true);

  }

  _onclickbuttondown(e){
      var userclicked = e.path[0].getAttribute("uid")
      console.info("Clicked > ",userclicked,e)
      this._broadcastevent(144,userclicked,127)
  }
  _onclickbuttonup(e){
      var userclicked = e.path[0].getAttribute("uid")
      console.info("Clicked > ",userclicked)
      this._broadcastevent(128,userclicked,127)
  }


  resetlights(){
      // reset midi lights
      for (var i = 1; i < 82; i++) {
        if(this.midienabled==true){
          Hypermodernism.Midi.sendlight("144",this.buttonmap[i][0],"00"); 
        } 
      }
  }

  loaddefaults(){
      this.buttonmap = this.defaultbuttonmap.slice(0)
      this._updateshaddowdom()
  }


  _broadcastevent(data1,data2,data3){

    var circuituievent = new CustomEvent('circuit.ui.event', { 'detail': {'data1':parseInt(data1), 'data2':parseInt(data2), 'data3':parseInt(data3)} });
    document.body.dispatchEvent(circuituievent);


    //test for key held
    if(parseInt(data1)==144){

      var circuiteventbuttondown = new CustomEvent('circuit.event.buttondown', { 'detail': {'button':parseInt(data2)} });
      document.body.dispatchEvent(circuiteventbuttondown);


      this.timeout[parseInt(data2)] = setTimeout(function(){
          // console.log("Button held",parseInt(data2))
          var circuiteventheld = new CustomEvent('circuit.event.held', { 'detail': {'button':parseInt(data2)} });
          document.body.dispatchEvent(circuiteventheld);
      
      }, this.timeoutval);
    }

    if(parseInt(data1)==128){
        clearTimeout(this.timeout[parseInt(data2)])
        
        var circuiteventbuttonup = new CustomEvent('circuit.event.buttonup', { 'detail': {'button':parseInt(data2)} });
        document.body.dispatchEvent(circuiteventbuttonup);
    };

  }


   


});
   
})();
</script>